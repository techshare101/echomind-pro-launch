<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Payment Successful | EchoMind Pro</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="./forge-theme.css" />
  <script src="lib/confetti/confetti.browser.min.js"></script>
  <style>
    /* ðŸŒŒ Forge Glow Orb */
    .forge-glow {
      position: fixed;
      bottom: 30px;
      right: 30px;
      width: 55px;
      height: 55px;
      background: radial-gradient(circle, #00e0ff, #7d4bff);
      border-radius: 50%;
      box-shadow: 0 0 25px rgba(125, 75, 255, 0.5), 0 0 50px rgba(0, 224, 255, 0.4);
      animation: pulse 4s ease-in-out infinite alternate;
      cursor: pointer;
      transition: transform 0.3s ease;
      z-index: 1000;
    }

    .forge-glow:hover {
      transform: scale(1.1);
      box-shadow: 0 0 40px rgba(125, 75, 255, 0.8), 0 0 80px rgba(0, 224, 255, 0.6);
    }

    @keyframes pulse {
      0% {
        filter: brightness(1);
        box-shadow: 0 0 20px rgba(125, 75, 255, 0.4), 0 0 40px rgba(0, 224, 255, 0.3);
      }
      100% {
        filter: brightness(1.3);
        box-shadow: 0 0 40px rgba(125, 75, 255, 0.8), 0 0 80px rgba(0, 224, 255, 0.6);
      }
    }
  </style>
</head>
<body>
  <!-- âœ… PAYMENT SUCCESS PANEL -->
  <div id="successPanel" class="transition-all duration-700 ease-in-out transform opacity-100 translate-y-0">
    <h1>âœ¨ Payment Successful!</h1>
    
    <!-- MetalMindTech Forge Seal -->
    <div class="logo">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 200 60" width="140" height="42" id="metalmindtech-insignia">
        <defs>
          <linearGradient id="forgeGradient" x1="0%" y1="0%" x2="100%" y2="100%">
            <stop offset="0%" stop-color="#5EEAD4"/>
            <stop offset="50%" stop-color="#7C3AED"/>
            <stop offset="100%" stop-color="#3B82F6"/>
          </linearGradient>
        </defs>
        <circle cx="30" cy="30" r="24" fill="none" stroke="url(#forgeGradient)" stroke-width="4"/>
        <path d="M30 10 L38 30 L30 50 L22 30 Z" fill="url(#forgeGradient)" opacity="0.8"/>
        <text x="60" y="36" fill="url(#forgeGradient)" font-family="Poppins, sans-serif" font-weight="600" font-size="20">
          MetalMindTech
        </text>
      </svg>
    </div>
    
    <h2 class="mt-2 text-lg text-cyan-400 font-semibold">Welcome to <span class="text-violet-400">Forge Mode</span></h2>
    <p class="verify-text">Your payment was successful! Activating Pro features...</p>

    <div id="verify-status" class="verify-text animate-pulse mt-6">
      ðŸ”„ Verifying your payment...
    </div>

    <!-- Dashboard Entry Button (initially hidden) -->
    <div id="dashboardEntry" class="hidden mt-8 text-center">
      <p class="text-green-400 font-semibold mb-4">ðŸŽ‰ EchoMind Pro Activated!</p>
      <button
        id="goToDashboardBtn"
        class="px-8 py-3 rounded-xl bg-gradient-to-r from-cyan-500 to-violet-500 text-white font-semibold hover:from-violet-500 hover:to-cyan-500 transition-all duration-300 hover:scale-105 shadow-lg hover:shadow-xl"
      >
        ðŸš€ Enter Forge Cockpit
      </button>
    </div>

    <div id="fallbackActions" class="flex justify-center mt-8">
      <button id="closeBtn" class="button danger-btn">Close Tab</button>
      <a href="chrome://extensions" class="button primary-btn">Reopen Extension</a>
    </div>
  </div>

  <script>
    // ðŸŽ‰ Confetti Celebration
    function fireConfetti() {
      const end = Date.now() + 2000;
      (function frame() {
        confetti({ particleCount: 5, angle: 60, spread: 55, origin: { x: 0 } });
        confetti({ particleCount: 5, angle: 120, spread: 55, origin: { x: 1 } });
        if (Date.now() < end) requestAnimationFrame(frame);
      })();
    }

    // âœ… Verify session & redirect
    (async () => {
      const params = new URLSearchParams(window.location.search);
      const sessionId = params.get("session_id");
      const statusBox = document.getElementById("verify-status");

      if (!sessionId) {
        statusBox.textContent = "âš ï¸ Missing session_id.";
        statusBox.classList.remove("animate-pulse");
        statusBox.classList.add("text-red-400");
        return;
      }

      try {
        const res = await fetch(
          `https://us-central1-echomind-pro-launch.cloudfunctions.net/api/verifySessionInstant?session_id=${sessionId}` 
        );

        if (res.ok) {
          const data = await res.json();
          
          // Store activation in localStorage for extension
          try {
            localStorage.setItem("isProActive", "true");
            localStorage.setItem("echomind_pro_active", "true");
            localStorage.setItem("echomind_pro_activated_at", new Date().toISOString());
            localStorage.setItem("echomind_pro_email", data.email || "publicuser@echomind.ai");
            localStorage.setItem("echomind_pro_plan", data.plan || "monthly");
          } catch (e) {
            console.log("Could not save to localStorage:", e);
          }
          
          fireConfetti();
          statusBox.classList.remove("animate-pulse");
          statusBox.classList.add("text-green-400");
          statusBox.textContent = "âœ… Verified! EchoMind Pro Activated!";
          
          // Show the dashboard entry button with animation
          setTimeout(() => {
            const dashboardEntry = document.getElementById("dashboardEntry");
            const fallbackActions = document.getElementById("fallbackActions");
            
            // Hide verification status and fallback actions
            statusBox.style.opacity = "0";
            fallbackActions.style.opacity = "0";
            
            setTimeout(() => {
              statusBox.style.display = "none";
              fallbackActions.style.display = "none";
              
              // Show dashboard entry with fade-in
              dashboardEntry.classList.remove("hidden");
              dashboardEntry.style.opacity = "0";
              dashboardEntry.style.transform = "translateY(20px)";
              
              setTimeout(() => {
                dashboardEntry.style.transition = "all 0.6s ease-out";
                dashboardEntry.style.opacity = "1";
                dashboardEntry.style.transform = "translateY(0)";
              }, 50);
            }, 300);
          }, 1500);
        } else {
          statusBox.classList.remove("animate-pulse");
          statusBox.textContent = "âš ï¸ Could not verify payment.";
          statusBox.classList.add("text-red-400");
        }
      } catch (err) {
        console.error("Verification error:", err);
        statusBox.classList.remove("animate-pulse");
        statusBox.textContent = "âš ï¸ Could not verify payment.";
        statusBox.classList.add("text-red-400");
      }
    })();

    // ðŸ§¹ Close Tab
    document.getElementById("closeBtn").addEventListener("click", () => {
      window.close();
    });
    
    // ðŸš€ Cinematic Dashboard Transition
    document.addEventListener("DOMContentLoaded", () => {
      const goToDashboardBtn = document.getElementById("goToDashboardBtn");
      const successPanel = document.getElementById("successPanel");
      
      if (goToDashboardBtn) {
        goToDashboardBtn.addEventListener("click", () => {
          // Add cinematic exit animation
          successPanel.style.transition = "all 0.7s ease-in-out";
          successPanel.style.transform = "translateY(-50%) scale(0.95)";
          successPanel.style.opacity = "0";
          
          // Navigate to dashboard after animation
          setTimeout(() => {
            window.location.href = "https://echomind-pro-launch.vercel.app/dashboard.html?from=success";
          }, 700);
        });
      }
    });
  </script>

  <!-- âœ¨ Forge Glow Orb -->
  <a href="https://echomind-pro-launch.vercel.app" class="forge-glow" title="Return to EchoMind Pro Home"></a>
</body>
</html>
