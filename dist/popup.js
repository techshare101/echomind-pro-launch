import"./modulepreload-polyfill.js";console.log("üß† EchoMind popup v0.4.0 Pro Edition loaded");const Z=document.getElementById("summarizeBtn"),Q=document.getElementById("explainBtn"),ee=document.getElementById("proofreadBtn"),te=document.getElementById("translateBtn"),oe=document.getElementById("vaultBtn"),ae=document.getElementById("clearVaultBtn"),ne=document.getElementById("status"),x=document.getElementById("summaryBox"),we=document.getElementById("settingsBtn"),I=document.getElementById("settingsPanel"),Y=document.getElementById("aiToggle"),q=document.getElementById("apiKeyInput"),ve=document.getElementById("saveSettingsBtn"),v=document.getElementById("proBox"),b=document.getElementById("proStatus"),A=document.getElementById("upgradeMonthly"),O=document.getElementById("upgradeAnnual"),xe="https://us-central1-echomind-pro-launch.cloudfunctions.net/api/createCheckoutSession",Ee="https://us-central1-echomind-pro-launch.cloudfunctions.net/api/checkSubscription";function i(e,t="info"){ne.textContent=e,ne.className=`status ${t}`}function S(e){e.classList.add("loading"),setTimeout(()=>e.classList.remove("loading"),1500)}function re(){x.classList.add("thinking")}function M(){x.classList.remove("thinking")}async function Ie(){try{const{sourceTabId:e}=await chrome.storage.local.get("sourceTabId");let t=null;if(e)t=e,console.log("Using stored tab ID:",t);else{const o=await chrome.tabs.query({active:!0,currentWindow:!1});o&&o.length>0&&o[0].id&&(t=o[0].id,console.log("Using active tab ID:",t))}if(!t)return console.log("No valid tab ID found"),"";const[{result:a}]=await chrome.scripting.executeScript({target:{tabId:t},func:()=>window.getSelection().toString()});return a||""}catch(e){return console.log("Cannot access tab:",e),""}}function z(e,t=!1){let a,o;return t?(a="Local Chrome AI (Fallback)",o="#f87171"):e.includes("OpenAI")?(a="GPT-4 via OpenAI",o="#8b5cf6"):e.includes("Claude")?(a="Claude via OpenRouter",o="#00ffff"):e.includes("Mistral")?(a="Mistral via OpenRouter",o="#ff6b6b"):e.includes("Gemini")?(a="Gemini via OpenRouter",o="#4285f4"):e.includes("OpenRouter")?(a="OpenRouter",o="#00ffff"):(a=e||"Unknown Provider",o="#aaa"),`
    <div style="
      background: linear-gradient(to right, ${o}33, transparent);
      border-left: 4px solid ${o};
      border-radius: 8px;
      padding: 8px 12px;
      margin-bottom: 12px;
      color: ${o};
      font-weight: 600;
      font-size: 0.85rem;
      display: flex;
      align-items: center;
      gap: 8px;
    ">
      <span style="font-size: 1.1rem;">‚òÅÔ∏è</span>
      <span>Cloud Summary: ${a}</span>
    </div>
  `}async function ie(e,t,a,o){const n=await chrome.storage.local.get(["showDebug","compactHUD"]),l=n.showDebug??!1,m=n.compactHUD??!1;if(!l)return"";const s={Claude:"linear-gradient(90deg, #00ffffaa, #8b5cf6aa)",OpenAI:"linear-gradient(90deg, #8b5cf6aa, #ff80b5aa)",Mistral:"linear-gradient(90deg, #f97316aa, #fde047aa)",Gemini:"linear-gradient(90deg, #38bdf8aa, #a855f7aa)",Local:"linear-gradient(90deg, #f87171aa, #facc15aa)"},r=e.includes("Claude")?s.Claude:e.includes("GPT-4")||e.includes("OpenAI")?s.OpenAI:e.includes("Mistral")?s.Mistral:e.includes("Gemini")?s.Gemini:s.Local,c=Math.min(o/5e3*100,100).toFixed(1),p=o<1e3?"#10b981":o<2500?"#facc15":"#ef4444";return m?`
      <div class="forge-trace-hud-compact" style="
        background: #0f172acc;
        border: 1px solid #1e293b;
        border-radius: 6px;
        margin-top: 6px;
        padding: 6px 10px;
        font-family: 'JetBrains Mono', monospace;
        color: #d1d5db;
        font-size: 0.75rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        animation: fadeIn 0.5s ease-in-out;
      ">
        <span style="font-weight:600; background:${r}; -webkit-background-clip:text; -webkit-text-fill-color:transparent;">
          ü§ñ ${e}
        </span>
        <span style="color:${p}; font-weight:600;">
          ‚è±Ô∏è ${o.toFixed(0)}ms
        </span>
      </div>
      <style>
        @keyframes fadeIn {
          from { opacity:0; transform:translateY(5px); }
          to { opacity:1; transform:translateY(0); }
        }
      </style>
    `:`
    <div class="forge-trace-hud" style="
      background: #0f172acc;
      border: 1px solid #1e293b;
      border-radius: 10px;
      margin-top: 8px;
      padding: 10px 14px;
      font-family: 'JetBrains Mono', monospace;
      color: #d1d5db;
      font-size: 0.85rem;
      box-shadow: 0 0 12px ${p}33;
      animation: fadeIn 0.5s ease-in-out;
    ">
      <div style="font-weight:600; background:${r}; -webkit-background-clip:text; -webkit-text-fill-color:transparent;">
        ‚öôÔ∏è Forge Trace HUD
      </div>
      <div style="margin-top:6px; line-height:1.5;">
        üåê <b>Endpoint:</b> <span style="font-size:0.75rem; color:#9ca3af;">${t}</span><br/>
        ü§ñ <b>Engine:</b> ${e}<br/>
        üìä <b>Status:</b> ${a}<br/>
      </div>
      <div style="margin-top:6px;">
        ‚è±Ô∏è <b>Latency:</b> ${o.toFixed(2)} ms
        <div style="
          width:100%; height:6px; border-radius:4px; margin-top:3px;
          background:#1f2937; overflow:hidden;
        ">
          <div style="
            width:${c}%;
            height:6px;
            background:${p};
            border-radius:4px;
            transition:width 0.5s ease-in-out;
            animation:pulseGlow 2s infinite ease-in-out;
          "></div>
        </div>
      </div>
    </div>

    <style>
      @keyframes fadeIn {
        from { opacity:0; transform:translateY(5px); }
        to { opacity:1; transform:translateY(0); }
      }
      @keyframes pulseGlow {
        0%, 100% { box-shadow: 0 0 6px ${p}66; }
        50% { box-shadow: 0 0 16px ${p}aa; }
      }
    </style>
  `}function G(){const e=document.createElement("div");if(e.style=`
    position:fixed; bottom:20px; right:20px;
    width:12px; height:12px;
    background: radial-gradient(circle, #00ffff, #8b5cf6);
    border-radius:50%; box-shadow:0 0 20px #00ffff;
    opacity:0.8; animation: forgePulse 2s infinite ease-in-out;
    z-index: 9999;
  `,document.body.appendChild(e),setTimeout(()=>e.remove(),4e3),!document.getElementById("forge-pulse-style")){const t=document.createElement("style");t.id="forge-pulse-style",t.textContent=`
      @keyframes forgePulse {
        0%,100% { transform: scale(1); opacity:0.6; }
        50% { transform: scale(1.8); opacity:1; }
      }
    `,document.head.appendChild(t)}}async function Te(e){return new Promise(t=>{chrome.runtime.sendMessage(e,a=>{const o=chrome.runtime.lastError;o?(console.warn("‚ö†Ô∏è Message failed:",o),t(null)):t(a)})})}async function le(e){if(!e)return"No text selected.";const t=e.split(" ");return`üîê Local Summary:
${t.slice(0,60).join(" ")+(t.length>60?"‚Ä¶":"")}

üí° Explanation:
This summary condenses the passage and explains why it may be relevant.`}async function ce(e,t){var a,o,n;try{const l=t.startsWith("sk-or-"),m=t.startsWith("sk-proj-")||t.startsWith("sk-")&&!t.startsWith("sk-ant-")&&!t.startsWith("sk-or-"),s=t.startsWith("sk-ant-"),r=t.startsWith("AIza"),c=!r&&(t.startsWith("mistral-")||/^[A-Za-z0-9]{32,40}$/.test(t));if(s||c){let d="";s?d="Claude":c&&(d="Mistral"),console.log(`ü§ñ Using ${d} via Forge Proxy for summarization`);const R=performance.now(),w=await fetch("https://us-central1-echomind-pro-launch.cloudfunctions.net/universalSummarize",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({apiKey:t,provider:d,text:e})}),E=performance.now()-R;if(!w.ok)return console.error(`‚ùå Proxy Error: ${w.status}`),`‚ö†Ô∏è ${d} (via Forge Proxy) error: ${w.status}`;const g=await w.json();return g.ok?(window.lastUsedProvider=`${d} (via Forge Proxy)`,window.lastTelemetry={provider:`${d} (via Forge Proxy)`,endpoint:g.endpoint||"Firebase Proxy",status:`${g.status} OK`,latency:g.latency||E,model:g.model},G(),`‚òÅÔ∏è AI Summary (${d} via Forge Proxy):
${g.summary}`):(console.error("‚ùå API Error:",g),window.lastTelemetry={provider:`${d} (via Forge Proxy)`,endpoint:g.endpoint||"Firebase Proxy",status:`${g.status} ERROR`,latency:E},`‚ö†Ô∏è ${d} error: ${g.reason}`)}if(r){const d="Gemini",R=performance.now();let w="",E="",g=0,k="Forge Proxy",H="",K="";try{console.log(`ü§ñ Using ${d} (via Forge Proxy) for summarization`),H="https://us-central1-echomind-pro-launch.cloudfunctions.net/geminiProxy";const j=await fetch(H,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({apiKey:t,text:e})});g=performance.now()-R;const P=await j.json();P.ok&&P.summary?(w=P.summary,E="200 OK",K=P.model,console.log(`‚úÖ Success with ${K} via Proxy (${g}ms)`)):(console.warn("‚ö†Ô∏è Gemini proxy failed:",P),E=`${P.status||502} Proxy Fail`)}catch(j){console.error("‚ùå Gemini proxy fetch error:",j),E="Network Error (Proxy)"}return w||console.error("‚ùå Gemini proxy failed and no fallback available for Google API keys"),window.lastUsedProvider=`${d} (via ${k})`,window.lastTelemetry={provider:`${d} (via ${k})`,endpoint:H,status:E,latency:g,model:K,route:k},w?(G(),`‚òÅÔ∏è AI Summary (${d} via ${k}):
${w}`):`‚ö†Ô∏è ${d} (${k}) error: ${E}`}let u,h,y;m?(u="https://api.openai.com/v1/chat/completions",h={"Content-Type":"application/json",Authorization:`Bearer ${t}`},y="OpenAI"):(u="https://openrouter.ai/api/v1/chat/completions",h={"Content-Type":"application/json",Authorization:`Bearer ${t}`,"HTTP-Referer":"https://echomind-pro-launch.vercel.app","X-Title":"EchoMind Pro"},y="OpenRouter"),console.log(`ü§ñ Using ${y} for summarization`),console.log(`üì° Endpoint: ${u}`);let T=l?"openai/gpt-4o-mini":"gpt-4o-mini";console.log(`üìã Model: ${T}`);const F=performance.now(),f=await fetch(u,{method:"POST",headers:h,body:JSON.stringify({model:T,messages:[{role:"system",content:`Provide a concise 2-part answer:

1Ô∏è‚É£ Summary ‚Äì 4‚Äì6 short paragraphs capturing key ideas.
2Ô∏è‚É£ Explanation ‚Äì why these points matter or what insights they reveal.`},{role:"user",content:e}]})}),_=performance.now()-F;if(!f.ok){console.error(`‚ùå API Error: ${f.status} ${f.statusText}`);const d=await f.text();return console.error("Error details:",d),window.lastTelemetry={provider:y,endpoint:u,status:`${f.status} ERROR`,latency:_},`‚ö†Ô∏è ${y} error: ${f.status} - ${f.statusText}`}const be=((n=(o=(a=(await f.json()).choices)==null?void 0:a[0])==null?void 0:o.message)==null?void 0:n.content)||"No result.";return window.lastUsedProvider=y,window.lastTelemetry={provider:y,endpoint:u,status:`${f.status} OK`,latency:_},G(),`‚òÅÔ∏è AI Summary (${y}):
${be}`}catch(l){return console.error("‚ùå Cloud summarizer error:",l),window.lastUsedProvider="Error - Fallback","‚ö†Ô∏è Cloud summarizer error."}}async function de(){var e;try{if(i("Connecting‚Ä¶"),!await Te({type:"ping"})){i("‚ö†Ô∏è Background inactive ‚Äî retrying‚Ä¶","warn"),setTimeout(de,1e3);return}i("Ready ‚úÖ");const{pendingSummary:a,pendingMode:o,openaiKey:n,enableCloud:l,targetLang:m}=await chrome.storage.local.get(["pendingSummary","pendingMode","openaiKey","enableCloud","targetLang"]);if(Y&&q&&(Y.checked=l||!1,q.value=n||""),a){console.log(`üì• Auto processing: ${o||"summarize"}`),re();const s=a,r=l&&n,c=o||"summarize",p=m||"English";let u="Summary",h=s;switch(c){case"explain":u="Explanation",h=`Explain this passage clearly and briefly:

${s}`;break;case"proofread":u="Proofread Result",h=`Proofread and correct the following text, improving grammar and clarity but keeping the meaning:

${s}`;break;case"translate":u=`Translation (${p})`,h=`Translate this text naturally into ${p}:

${s}`;break;default:u="Summary",h=`Summarize this text and briefly explain why it matters:

${s}`;break}const y=r?await ce(h,n):await le(s);x.setAttribute("data-mode",c);const T=window.lastUsedProvider||(r?"Cloud AI":"Local"),F=r?z(T,!1):z("Local",!0);let f="";r&&window.lastTelemetry&&(f=await ie(window.lastTelemetry.provider,window.lastTelemetry.endpoint,window.lastTelemetry.status,window.lastTelemetry.latency)),x.innerHTML=`${F}${f}<strong>${u}:</strong><br>${y.replace(/\n/g,"<br>")}`,x.scrollTop=0,await chrome.storage.local.set({lastSummaryLength:y.length}),M(),i(`${u} complete ‚úÖ`);const U=((e=(await chrome.storage.local.get("vaultData")).vaultData)==null?void 0:e.entries)||[];U.push({text:s,summary:y,date:new Date().toISOString(),mode:c,lang:p||null}),await chrome.storage.local.set({vaultData:{entries:U}}),await chrome.storage.local.remove(["pendingSummary","pendingMode","targetLang","sourceTabId"])}}catch(t){console.error("üí´ Init error:",t),i("Error initializing","error")}}async function D(e,t="English"){var a;try{re(),i(`Processing ${e}...`);const o=await Ie();if(!o.trim()){M(),i("Please highlight some text first ‚ö†Ô∏è","warn");return}const{openaiKey:n,enableCloud:l}=await chrome.storage.local.get(["openaiKey","enableCloud"]),m=l&&n;let s="",r="";switch(e){case"explain":s="Explanation",r=`Explain this passage clearly and briefly:

${o}`;break;case"proofread":s="Proofread Result",r=`Proofread and correct the following text, improving grammar and clarity but keeping the meaning:

${o}`;break;case"translate":s=`Translation (${t})`,r=`Translate this text naturally into ${t}:

${o}`;break;default:s="Summary",r=`Summarize this text and briefly explain why it matters:

${o}`;break}const c=m?await ce(r,n):await le(o);x.setAttribute("data-mode",e);const p=window.lastUsedProvider||(m?"Cloud AI":"Local"),u=m?z(p,!1):z("Local",!0);let h="";m&&window.lastTelemetry&&(h=await ie(window.lastTelemetry.provider,window.lastTelemetry.endpoint,window.lastTelemetry.status,window.lastTelemetry.latency)),x.innerHTML=`${u}${h}<strong>${s}:</strong><br>${c.replace(/\n/g,"<br>")}`,x.scrollTop=0,await chrome.storage.local.set({lastSummaryLength:c.length}),M(),i(`${s} complete ‚úÖ`);const T=((a=(await chrome.storage.local.get("vaultData")).vaultData)==null?void 0:a.entries)||[];T.push({text:o,summary:c,date:new Date().toISOString(),mode:e,lang:t||null}),await chrome.storage.local.set({vaultData:{entries:T}}),await chrome.storage.local.remove("sourceTabId")}catch(o){console.error(`üí´ ${e} error:`,o),M(),i(`Error in ${e}`,"error")}}Z.addEventListener("click",()=>{S(Z),D("summarize")});Q.addEventListener("click",()=>{S(Q),D("explain")});ee.addEventListener("click",()=>{S(ee),D("proofread")});te.addEventListener("click",async()=>{S(te);const e=prompt("Translate to which language?","Spanish");e&&e.trim()?await D("translate",e.trim()):i("Translation cancelled","warn")});oe.addEventListener("click",async()=>{S(oe);const e=document.getElementById("vaultContainer"),t=document.getElementById("summaryBox"),a=e.querySelectorAll(".filter"),o=document.getElementById("vaultEntries");t.classList.add("hidden"),e.classList.remove("hidden");const{vaultData:n}=await chrome.storage.local.get("vaultData"),l=(n==null?void 0:n.entries)||[];if(l.length===0){o.innerHTML="<p>Vault is empty.</p>",i("Vault loaded ‚úÖ");return}const m=s=>{a.forEach(c=>c.classList.toggle("active",c.dataset.filter===s));const r=s==="all"?l:l.filter(c=>c.mode===s);o.innerHTML=r.length===0?`<p>No entries found for "${s}".</p>`:r.map((c,p)=>`
          <div class="vault-entry">
            <strong>#${p+1} ‚Äì ${c.mode.toUpperCase()}${c.lang?" ("+c.lang+")":""}</strong><br>
            <small>${new Date(c.date).toLocaleString()}</small><br>
            <p>${c.summary.replace(/\n/g,"<br>")}</p>
          </div>`).join("<hr>")};m("all"),a.forEach(s=>s.addEventListener("click",()=>m(s.dataset.filter))),i("Vault loaded ‚úÖ")});ae.addEventListener("click",async()=>{confirm("Clear all Vault data?")&&(S(ae),await chrome.storage.local.clear(),x.textContent="",i("Vault cleared üßπ"))});const $=document.getElementById("mainPanel"),W=document.getElementById("manageSubBtn"),me=document.getElementById("backBtn"),Pe="https://us-central1-echomind-pro-launch.cloudfunctions.net/api/createCustomerPortalSession";we.addEventListener("click",()=>{$.classList.add("translate-x-[-100%]","opacity-0"),$.classList.remove("translate-x-0","opacity-100"),setTimeout(()=>{$.style.display="none",I.classList.remove("hidden"),setTimeout(()=>{I.classList.remove("translate-x-full","opacity-0"),I.classList.add("translate-x-0","opacity-100")},30)},250)});me.addEventListener("click",()=>{I.classList.add("translate-x-full","opacity-0"),I.classList.remove("translate-x-0","opacity-100"),setTimeout(()=>{I.classList.add("hidden"),$.style.display="block",setTimeout(()=>{$.classList.remove("translate-x-[-100%]","opacity-0"),$.classList.add("translate-x-0","opacity-100")},30)},300)});const N=document.getElementById("portalOverlay"),L=document.getElementById("portalFrame");document.getElementById("portalLoader");const $e=document.getElementById("portalProgress"),Se=document.getElementById("closePortalBtn");async function ue(){try{i("Opening Stripe portal...","info");const e=localStorage.getItem("echomind_pro_email")||localStorage.getItem("userEmail")||localStorage.getItem("user_email");if(console.log("üîç Looking up portal for email:",e),!e||e==="publicuser@echomind.ai"){i("‚ö†Ô∏è Please complete a purchase first","error"),console.warn("No valid user email found in localStorage");return}const t=await fetch(Pe,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:e})});if(console.log("üì° Portal response status:",t.status),!t.ok){const o=await t.json().catch(()=>({}));throw console.error("‚ùå Portal error:",o),new Error(o.error||`HTTP ${t.status}: ${t.statusText}`)}const a=await t.json();if(console.log("‚úÖ Portal data received:",a),a.url)console.log("üöÄ Opening Stripe portal in new tab:",a.url),chrome.tabs.create({url:a.url}),i("‚úÖ Portal opened in new tab","success");else throw new Error("No portal URL received from server")}catch(e){console.error("‚ùå Error opening customer portal:",e),i(`‚ùå ${e.message||"Unable to open portal"}`,"error"),(e.message.includes("Customer not found")||e.message.includes("404"))&&i("‚ùå No subscription found. Please upgrade first.","error")}}function pe(){N.classList.add("opacity-0"),N.style.pointerEvents="none",setTimeout(()=>{N.classList.add("hidden"),L.src="",L.classList.remove("loaded"),$e.style.width="0%"},400),i("Portal closed","info")}W.addEventListener("click",()=>{W.style.transform="scale(0.97)",setTimeout(()=>{W.style.transform="scale(1)"},150),ue()});Se.addEventListener("click",pe);ve.addEventListener("click",async()=>{await chrome.storage.local.set({enableCloud:Y.checked,openaiKey:q.value.trim()}),I.classList.add("hidden"),i("Settings saved ‚úÖ")});const V=document.getElementById("openDashboardBtn");V==null||V.addEventListener("click",async()=>{let e=!1;try{await new Promise((a,o)=>{const n=setTimeout(()=>o(new Error("Dashboard timeout")),1e3);chrome.runtime.openOptionsPage(()=>{clearTimeout(n),chrome.runtime.lastError?o(chrome.runtime.lastError):a()})}),e=!0}catch(t){console.warn("‚ö†Ô∏è Dashboard open failed or timed out:",t)}e||ke()});function ke(){const e=document.getElementById("app");e.style.display="none";const t=document.createElement("div");t.className="mini-dashboard",t.innerHTML=`
    <h3>‚öôÔ∏è EchoMind Mini Dashboard</h3>
    <p style="color: #aaa; font-size: 12px;">Fallback mode - full dashboard unavailable</p>
    <label>
      <input type="checkbox" id="miniAiToggle"> Enable Cloud AI (OpenAI)
    </label><br>
    <textarea id="miniApiKey" placeholder="Enter your OpenAI API key here (sk-...)"></textarea><br>
    <button id="miniSave">üíæ Save Settings</button>
    <button id="miniBack">‚Üê Back</button>
    <hr style="border-color: #333; margin: 12px 0;">
    <button id="miniClearVault" style="background: #ff4444; color: white;">üßπ Clear Vault</button>
  `,document.body.appendChild(t),chrome.storage.local.get(["enableCloud","openaiKey"],({enableCloud:a,openaiKey:o})=>{document.getElementById("miniAiToggle").checked=a||!1,document.getElementById("miniApiKey").value=o||""}),document.getElementById("miniSave").addEventListener("click",async()=>{await chrome.storage.local.set({enableCloud:document.getElementById("miniAiToggle").checked,openaiKey:document.getElementById("miniApiKey").value.trim()}),i("Settings saved ‚úÖ"),setTimeout(()=>{t.remove(),e.style.display="block"},1500)}),document.getElementById("miniClearVault").addEventListener("click",async()=>{confirm("‚ö†Ô∏è Clear all vault entries? This cannot be undone!")&&(await chrome.storage.local.remove("vaultData"),i("Vault cleared üßπ"))}),document.getElementById("miniBack").addEventListener("click",()=>{t.remove(),e.style.display="block"})}const J=document.getElementById("backToMainBtn");J==null||J.addEventListener("click",()=>{const e=document.getElementById("vaultContainer"),t=document.getElementById("summaryBox");e.classList.add("hidden"),t.classList.remove("hidden"),i("Ready ‚úÖ")});function se(e,t="info"){const a=document.createElement("div");a.textContent=e,a.style.position="fixed",a.style.bottom="20px",a.style.left="50%",a.style.transform="translateX(-50%)",a.style.padding="10px 20px",a.style.borderRadius="8px",a.style.fontSize="0.9rem",a.style.zIndex="9999",a.style.boxShadow="0 4px 12px rgba(0, 0, 0, 0.3)",a.style.transition="all 0.3s ease",t==="success"?(a.style.background="rgba(34, 197, 94, 0.9)",a.style.color="white"):t==="error"?(a.style.background="rgba(239, 68, 68, 0.9)",a.style.color="white"):(a.style.background="rgba(59, 130, 246, 0.9)",a.style.color="white"),document.body.appendChild(a),setTimeout(()=>{a.style.opacity="1"},10),setTimeout(()=>{a.style.opacity="0",setTimeout(()=>a.remove(),300)},2500)}async function ge(){try{let{userEmail:e}=await chrome.storage.local.get("userEmail");e||(e="publicuser@echomind.ai",console.log("No user email found, using public email for checkout"));const t=await fetch(`${Ee}?email=${e}`,{method:"GET",headers:{"Content-Type":"application/json"}});if(!t.ok)throw new Error(`HTTP ${t.status}: ${t.statusText}`);const a=await t.json();if(a.status==="active"){console.log("‚úÖ EchoMind Pro verified active"),localStorage.setItem("isProActive","true"),localStorage.setItem("proActivatedAt",new Date().toISOString());const o=a.email||e;o&&o!=="publicuser@echomind.ai"&&(localStorage.setItem("echomind_pro_email",o),console.log("üíæ Saved user email for portal access:",o)),b==null||b.classList.remove("hidden"),v==null||v.classList.add("hidden"),i("‚ú® Pro Active","success");const n=localStorage.getItem("lastProToast"),l=Date.now();return(!n||l-parseInt(n)>36e5)&&(se("‚ú® EchoMind Pro activated ‚Äî welcome back!","success"),localStorage.setItem("lastProToast",l.toString())),localStorage.getItem("forgeWelcomeShown")||setTimeout(()=>{const s=document.getElementById("forge-welcome-popup");s&&(s.classList.remove("hidden"),s.style.opacity="1",s.style.transform="translateY(0)",s.style.animation="forgePulseText 4s ease-in-out 1",setTimeout(()=>{s.style.opacity="0",s.style.transform="translateY(10px)",localStorage.setItem("forgeWelcomeShown","true"),setTimeout(()=>{s.classList.add("hidden")},1e3)},5e3))},1500),!0}else return console.log("‚ö†Ô∏è EchoMind Pro inactive, showing upgrade box"),localStorage.setItem("isProActive","false"),b==null||b.classList.add("hidden"),v==null||v.classList.remove("hidden"),!1}catch(e){return console.error("Error checking subscription:",e),b==null||b.classList.add("hidden"),v==null||v.classList.remove("hidden"),se("‚ö†Ô∏è Could not verify Pro status. Try again later.","error"),!1}}async function ye(e){const t=e==="monthly"?A:O,a=t.innerHTML;try{t.innerHTML='<span style="font-size: 0.9rem;">‚è≥ Loading...</span>',t.disabled=!0,console.log(`Creating ${e} checkout session...`);const o=await fetch(`${xe}?plan=${e}`,{method:"POST",headers:{"Content-Type":"application/json"}});if(!o.ok)throw new Error(`HTTP ${o.status}: ${o.statusText}`);const n=await o.json();if(n.url)console.log("‚úÖ Checkout session created:",n.sessionId),chrome.tabs.create({url:n.url}),i(`Opening ${e} checkout...`,"success");else throw new Error("No checkout URL returned")}catch(o){console.error("‚ùå Error creating checkout session:",o),i("Checkout failed. Please try again.","error"),alert(`Failed to create checkout session: ${o.message}`),t.innerHTML=a,t.disabled=!1}}A==null||A.addEventListener("click",()=>ye("monthly"));O==null||O.addEventListener("click",()=>ye("annual"));function Le(){const e=b;!e||e.classList.contains("hidden")||(e.style.animation="forgePulse 2s ease-in-out 1",setTimeout(()=>{e.style.animation=""},2e3))}function Be(){const e=document.createElement("canvas");e.id="popup-confetti",e.style.position="fixed",e.style.top="0",e.style.left="0",e.style.width="100%",e.style.height="100%",e.style.pointerEvents="none",e.style.zIndex="9999",document.body.appendChild(e);const t=e.getContext("2d");e.width=window.innerWidth,e.height=window.innerHeight;const a=Array.from({length:80},()=>({x:Math.random()*e.width,y:Math.random()*e.height-e.height,size:Math.random()*4+2,color:`hsl(${Math.random()*360}, 100%, 60%)`,speed:Math.random()*3+1,angle:Math.random()*Math.PI*2}));function o(){t.clearRect(0,0,e.width,e.height),a.forEach(n=>{n.y+=n.speed,n.x+=Math.sin(n.angle)*.3,n.y>e.height&&(n.y=-10),t.fillStyle=n.color,t.fillRect(n.x,n.y,n.size,n.size)}),requestAnimationFrame(o)}o(),setTimeout(()=>{e.style.opacity="0",e.style.transition="opacity 1s ease",setTimeout(()=>e.remove(),1e3)},3e3)}function he(){const e=localStorage.getItem("isProActive")==="true",t=localStorage.getItem("lastProCelebration"),a=Date.now();e&&(!t||a-parseInt(t)>36e5)&&setTimeout(()=>{console.log("üéä Celebrating Pro activation!"),Le(),Be(),localStorage.setItem("lastProCelebration",a.toString())},800)}ge().then(()=>{he()});de();function fe(){console.log("üîÑ Resetting UI state..."),["settingsPanel","portalOverlay"].forEach(a=>{const o=document.getElementById(a);o&&(o.classList.add("hidden"),o.style.pointerEvents="none",o.style.opacity="0",o.style.display="none")});const t=document.getElementById("mainPanel");t&&(t.classList.remove("hidden"),t.style.display="block",t.style.pointerEvents="auto",t.style.opacity="1",t.classList.remove("translate-x-[-100%]","opacity-0"),t.classList.add("translate-x-0","opacity-100")),L&&(L.src="",L.classList.remove("loaded")),console.log("‚úÖ UI state reset complete")}document.addEventListener("keydown",e=>{e.key==="Escape"&&(N.classList.contains("hidden")?I.classList.contains("hidden")?fe():me.click():pe())});window.resetUIState=fe;let B=null;async function X(){const e=document.getElementById("planBadge"),t=document.getElementById("planName"),a=document.getElementById("planStatus"),o=document.getElementById("planManageBtn"),n=document.getElementById("proBox");if(!e||!t||!a||!o){console.warn("‚ö†Ô∏è Plan badge elements not found");return}try{const l=localStorage.getItem("echomind_pro_email")||localStorage.getItem("userEmail")||localStorage.getItem("user_email");if(!l||l==="publicuser@echomind.ai"){e.classList.add("hidden"),n&&n.classList.remove("hidden"),console.log("üì¶ No subscription - showing upgrade box");return}const m=localStorage.getItem("echomind_pro_status")==="true",s=localStorage.getItem("echomind_plan_type")||"starter";if(console.log("üîç Plan badge update:",{isPro:m,planType:s,userEmail:l}),!m){e.classList.add("hidden"),n&&n.classList.remove("hidden");return}e.classList.remove("hidden"),n&&n.classList.add("hidden");let r={text:"Starter Plan",status:"Free Tier Active",className:"starter",showManage:!1};s==="monthly"||s==="pro"?r={text:"Pro Plan",status:"Monthly Subscription Active",className:"pro",showManage:!0}:(s==="annual"||s==="yearly")&&(r={text:"Annual Plan",status:"Annual Subscription Active",className:"annual",showManage:!0}),e.className=`plan-badge ${r.className}`,t.textContent=`EchoMind ${r.text}`,a.textContent=r.status,r.showManage?(o.style.display="block",o.onclick=()=>{console.log(`üöÄ Opening Stripe portal for ${r.text}`),ue()}):o.style.display="none",console.log(`‚úÖ Plan badge updated: ${r.text}`)}catch(l){console.error("‚ùå Error updating plan badge:",l),e.classList.remove("hidden"),e.className="plan-badge starter",t.textContent="EchoMind Starter",a.textContent="Free tier active",o.style.display="none"}}function Ce(){B&&(B(),B=null);const e=localStorage.getItem("echomind_pro_email")||localStorage.getItem("userEmail")||localStorage.getItem("user_email");if(!e||e==="publicuser@echomind.ai"){console.log("üì¶ No user email - skipping Firestore listener");return}try{const a=firebase.firestore().collection("user_subscription_status").doc(e);console.log("üëÇ Setting up real-time plan badge listener for:",e),B=a.onSnapshot(o=>{if(o.exists){const n=o.data();console.log("üîÑ Subscription data updated:",n),localStorage.setItem("echomind_pro_status",n.isPro?"true":"false"),localStorage.setItem("echomind_plan_type",n.planType||"starter"),localStorage.setItem("echomind_pro_email",e),X(),n.isPro&&i(`‚úÖ ${n.planType==="annual"?"Annual":"Pro"} plan active`,"success")}else console.log("üì≠ No subscription document found"),localStorage.setItem("echomind_pro_status","false"),localStorage.setItem("echomind_plan_type","starter"),X()},o=>{console.error("‚ùå Firestore listener error:",o)}),console.log("‚úÖ Real-time plan badge listener active")}catch(t){console.error("‚ùå Error setting up Firestore listener:",t)}}X();ge().then(()=>{Ce(),he()});function Ae(e,t=2500){const a=document.createElement("div");a.textContent=e,a.className="forge-toast animate-toast-fade",document.body.appendChild(a),setTimeout(()=>{a.style.opacity="1"},50),setTimeout(()=>{a.style.opacity="0"},t-500),setTimeout(()=>{a.remove()},t)}const C=document.getElementById("manageSubBtn");if(C){const e=C.cloneNode(!0);C.parentNode.replaceChild(e,C),e.addEventListener("click",()=>{const t="https://echomind-pro-launch.vercel.app/dashboard?from=success";console.log("üöÄ Opening Forge Cockpit at:",t),e.style.transform="scale(0.95)",setTimeout(()=>{e.style.transform="scale(1)"},150),Ae("üöÄ Opening Forge Cockpit..."),setTimeout(()=>{chrome.tabs.create({url:t})},900)})}
