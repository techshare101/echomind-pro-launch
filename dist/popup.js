import"./modulepreload-polyfill.js";console.log("üß† EchoMind popup v0.4.0 Pro Edition loaded");const A=document.getElementById("summarizeBtn"),D=document.getElementById("explainBtn"),O=document.getElementById("proofreadBtn"),z=document.getElementById("translateBtn"),N=document.getElementById("vaultBtn"),H=document.getElementById("clearVaultBtn"),U=document.getElementById("status"),h=document.getElementById("summaryBox"),X=document.getElementById("settingsBtn"),p=document.getElementById("settingsPanel"),V=document.getElementById("aiToggle"),j=document.getElementById("apiKeyInput"),Q=document.getElementById("saveSettingsBtn"),y=document.getElementById("proBox"),m=document.getElementById("proStatus"),T=document.getElementById("upgradeMonthly"),S=document.getElementById("upgradeAnnual"),Z="https://us-central1-echomind-pro-launch.cloudfunctions.net/api/createCheckoutSession",ee="https://us-central1-echomind-pro-launch.cloudfunctions.net/api/checkSubscription";function r(e,t="info"){U.textContent=e,U.className=`status ${t}`}function E(e){e.classList.add("loading"),setTimeout(()=>e.classList.remove("loading"),1500)}function _(){h.classList.add("thinking")}function B(){h.classList.remove("thinking")}async function te(){try{const{sourceTabId:e}=await chrome.storage.local.get("sourceTabId");let t=null;if(e)t=e,console.log("Using stored tab ID:",t);else{const n=await chrome.tabs.query({active:!0,currentWindow:!1});n&&n.length>0&&n[0].id&&(t=n[0].id,console.log("Using active tab ID:",t))}if(!t)return console.log("No valid tab ID found"),"";const[{result:a}]=await chrome.scripting.executeScript({target:{tabId:t},func:()=>window.getSelection().toString()});return a||""}catch(e){return console.log("Cannot access tab:",e),""}}async function ae(e){return new Promise(t=>{chrome.runtime.sendMessage(e,a=>{const n=chrome.runtime.lastError;n?(console.warn("‚ö†Ô∏è Message failed:",n),t(null)):t(a)})})}async function F(e){if(!e)return"No text selected.";const t=e.split(" ");return`üîê Local Summary:
${t.slice(0,60).join(" ")+(t.length>60?"‚Ä¶":"")}

üí° Explanation:
This summary condenses the passage and explains why it may be relevant.`}async function K(e,t){var a,n,o;try{return`‚òÅÔ∏è AI Summary:
${((o=(n=(a=(await(await fetch("https://api.openai.com/v1/chat/completions",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t}`},body:JSON.stringify({model:"gpt-4o-mini",messages:[{role:"system",content:`Provide a concise 2-part answer:

1Ô∏è‚É£ Summary ‚Äì 4‚Äì6 short paragraphs capturing key ideas.
2Ô∏è‚É£ Explanation ‚Äì why these points matter or what insights they reveal.`},{role:"user",content:e}]})})).json()).choices)==null?void 0:a[0])==null?void 0:n.message)==null?void 0:o.content)||"No result."}`}catch(i){return console.error(i),"‚ö†Ô∏è Cloud summarizer error."}}async function W(){var e;try{if(r("Connecting‚Ä¶"),!await ae({type:"ping"})){r("‚ö†Ô∏è Background inactive ‚Äî retrying‚Ä¶","warn"),setTimeout(W,1e3);return}r("Ready ‚úÖ");const{pendingSummary:a,pendingMode:n,aiSettings:o,targetLang:i}=await chrome.storage.local.get(["pendingSummary","pendingMode","aiSettings","targetLang"]);if(o&&(V.checked=o.enabled,j.value=o.key||""),a){console.log(`üì• Auto processing: ${n||"summarize"}`),_();const c=a,s=o==null?void 0:o.key,d=(o==null?void 0:o.enabled)&&s,l=n||"summarize",f=i||"English";let g="Summary",b=c;switch(l){case"explain":g="Explanation",b=`Explain this passage clearly and briefly:

${c}`;break;case"proofread":g="Proofread Result",b=`Proofread and correct the following text, improving grammar and clarity but keeping the meaning:

${c}`;break;case"translate":g=`Translation (${f})`,b=`Translate this text naturally into ${f}:

${c}`;break;default:g="Summary",b=`Summarize this text and briefly explain why it matters:

${c}`;break}const P=d?await K(b,s):await F(c);h.setAttribute("data-mode",l),h.innerHTML=`<strong>${g}:</strong><br>${P.replace(/\n/g,"<br>")}`,h.scrollTop=0,await chrome.storage.local.set({lastSummaryLength:P.length}),B(),r(`${g} complete ‚úÖ`);const M=((e=(await chrome.storage.local.get("vaultData")).vaultData)==null?void 0:e.entries)||[];M.push({text:c,summary:P,date:new Date().toISOString(),mode:l,lang:f||null}),await chrome.storage.local.set({vaultData:{entries:M}}),await chrome.storage.local.remove(["pendingSummary","pendingMode","targetLang","sourceTabId"])}}catch(t){console.error("üí´ Init error:",t),r("Error initializing","error")}}async function x(e,t="English"){var a;try{_(),r(`Processing ${e}...`);const n=await te();if(!n.trim()){B(),r("Please highlight some text first ‚ö†Ô∏è","warn");return}const{aiSettings:o}=await chrome.storage.local.get("aiSettings"),i=o==null?void 0:o.key,c=(o==null?void 0:o.enabled)&&i;let s="",d="";switch(e){case"explain":s="Explanation",d=`Explain this passage clearly and briefly:

${n}`;break;case"proofread":s="Proofread Result",d=`Proofread and correct the following text, improving grammar and clarity but keeping the meaning:

${n}`;break;case"translate":s=`Translation (${t})`,d=`Translate this text naturally into ${t}:

${n}`;break;default:s="Summary",d=`Summarize this text and briefly explain why it matters:

${n}`;break}const l=c?await K(d,i):await F(n);h.setAttribute("data-mode",e),h.innerHTML=`<strong>${s}:</strong><br>${l.replace(/\n/g,"<br>")}`,h.scrollTop=0,await chrome.storage.local.set({lastSummaryLength:l.length}),B(),r(`${s} complete ‚úÖ`);const g=((a=(await chrome.storage.local.get("vaultData")).vaultData)==null?void 0:a.entries)||[];g.push({text:n,summary:l,date:new Date().toISOString(),mode:e,lang:t||null}),await chrome.storage.local.set({vaultData:{entries:g}}),await chrome.storage.local.remove("sourceTabId")}catch(n){console.error(`üí´ ${e} error:`,n),B(),r(`Error in ${e}`,"error")}}A.addEventListener("click",()=>{E(A),x("summarize")});D.addEventListener("click",()=>{E(D),x("explain")});O.addEventListener("click",()=>{E(O),x("proofread")});z.addEventListener("click",async()=>{E(z);const e=prompt("Translate to which language?","Spanish");e&&e.trim()?await x("translate",e.trim()):r("Translation cancelled","warn")});N.addEventListener("click",async()=>{E(N);const e=document.getElementById("vaultContainer"),t=document.getElementById("summaryBox"),a=e.querySelectorAll(".filter"),n=document.getElementById("vaultEntries");t.classList.add("hidden"),e.classList.remove("hidden");const{vaultData:o}=await chrome.storage.local.get("vaultData"),i=(o==null?void 0:o.entries)||[];if(i.length===0){n.innerHTML="<p>Vault is empty.</p>",r("Vault loaded ‚úÖ");return}const c=s=>{a.forEach(l=>l.classList.toggle("active",l.dataset.filter===s));const d=s==="all"?i:i.filter(l=>l.mode===s);n.innerHTML=d.length===0?`<p>No entries found for "${s}".</p>`:d.map((l,f)=>`
          <div class="vault-entry">
            <strong>#${f+1} ‚Äì ${l.mode.toUpperCase()}${l.lang?" ("+l.lang+")":""}</strong><br>
            <small>${new Date(l.date).toLocaleString()}</small><br>
            <p>${l.summary.replace(/\n/g,"<br>")}</p>
          </div>`).join("<hr>")};c("all"),a.forEach(s=>s.addEventListener("click",()=>c(s.dataset.filter))),r("Vault loaded ‚úÖ")});H.addEventListener("click",async()=>{confirm("Clear all Vault data?")&&(E(H),await chrome.storage.local.clear(),h.textContent="",r("Vault cleared üßπ"))});const v=document.getElementById("mainPanel"),I=document.getElementById("manageSubBtn"),q=document.getElementById("backBtn"),ne="https://us-central1-echomind-pro-launch.cloudfunctions.net/api/createCustomerPortalSession";X.addEventListener("click",()=>{v.classList.add("translate-x-[-100%]","opacity-0"),v.classList.remove("translate-x-0","opacity-100"),setTimeout(()=>{v.style.display="none",p.classList.remove("hidden"),setTimeout(()=>{p.classList.remove("translate-x-full","opacity-0"),p.classList.add("translate-x-0","opacity-100")},30)},250)});q.addEventListener("click",()=>{p.classList.add("translate-x-full","opacity-0"),p.classList.remove("translate-x-0","opacity-100"),setTimeout(()=>{p.classList.add("hidden"),v.style.display="block",setTimeout(()=>{v.classList.remove("translate-x-[-100%]","opacity-0"),v.classList.add("translate-x-0","opacity-100")},30)},300)});const k=document.getElementById("portalOverlay"),u=document.getElementById("portalFrame"),L=document.getElementById("portalLoader"),w=document.getElementById("portalProgress"),oe=document.getElementById("closePortalBtn");async function se(){try{r("Initializing Forge Portal...","info");const e=localStorage.getItem("echomind_pro_email")||localStorage.getItem("userEmail")||localStorage.getItem("user_email");if(console.log("üîç Looking up portal for email:",e),!e||e==="publicuser@echomind.ai"){r("‚ö†Ô∏è Please complete a purchase first","error"),console.warn("No valid user email found in localStorage");return}const t=await fetch(ne,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:e})});if(console.log("üì° Portal response status:",t.status),!t.ok){const n=await t.json().catch(()=>({}));throw console.error("‚ùå Portal error:",n),new Error(n.error||`HTTP ${t.status}: ${t.statusText}`)}const a=await t.json();if(console.log("‚úÖ Portal data received:",a),a.url){u.src=a.url,k.classList.remove("hidden"),w.style.width="0%",L.style.display="flex",u.classList.remove("loaded");let n=0;const o=setInterval(()=>{n+=Math.random()*15+5,n>95&&(n=95),w.style.width=`${n}%`},200);u.onload=()=>{clearInterval(o),w.style.width="100%",setTimeout(()=>{L.style.display="none",u.classList.add("loaded"),r("‚úÖ Forge Portal ready","success")},500)},setTimeout(()=>{L.style.display!=="none"&&(clearInterval(o),w.style.width="100%",setTimeout(()=>{L.style.display="none",u.classList.add("loaded")},500))},5e3),I.style.transform="scale(0.95)",setTimeout(()=>{I.style.transform="scale(1)"},150)}else throw new Error("No portal URL received from server")}catch(e){console.error("‚ùå Error opening customer portal:",e),r(`‚ùå ${e.message||"Unable to open portal"}`,"error"),(e.message.includes("Customer not found")||e.message.includes("404"))&&r("‚ùå No subscription found. Please upgrade first.","error")}}function J(){k.classList.add("opacity-0"),k.style.pointerEvents="none",setTimeout(()=>{k.classList.add("hidden"),u.src="",u.classList.remove("loaded"),w.style.width="0%"},400),r("Portal closed","info")}I.addEventListener("click",()=>{I.style.transform="scale(0.97)",setTimeout(()=>{I.style.transform="scale(1)"},150),se()});oe.addEventListener("click",J);Q.addEventListener("click",async()=>{const e={enabled:V.checked,key:j.value.trim()};await chrome.storage.local.set({aiSettings:e}),p.classList.add("hidden"),r("Settings saved ‚úÖ")});const $=document.getElementById("openDashboardBtn");$==null||$.addEventListener("click",async()=>{let e=!1;try{await new Promise((a,n)=>{const o=setTimeout(()=>n(new Error("Dashboard timeout")),1e3);chrome.runtime.openOptionsPage(()=>{clearTimeout(o),chrome.runtime.lastError?n(chrome.runtime.lastError):a()})}),e=!0}catch(t){console.warn("‚ö†Ô∏è Dashboard open failed or timed out:",t)}e||re()});function re(){const e=document.getElementById("app");e.style.display="none";const t=document.createElement("div");t.className="mini-dashboard",t.innerHTML=`
    <h3>‚öôÔ∏è EchoMind Mini Dashboard</h3>
    <p style="color: #aaa; font-size: 12px;">Fallback mode - full dashboard unavailable</p>
    <label>
      <input type="checkbox" id="miniAiToggle"> Enable Cloud AI (OpenAI)
    </label><br>
    <textarea id="miniApiKey" placeholder="Enter your OpenAI API key here (sk-...)"></textarea><br>
    <button id="miniSave">üíæ Save Settings</button>
    <button id="miniBack">‚Üê Back</button>
    <hr style="border-color: #333; margin: 12px 0;">
    <button id="miniClearVault" style="background: #ff4444; color: white;">üßπ Clear Vault</button>
  `,document.body.appendChild(t),chrome.storage.local.get("aiSettings",({aiSettings:a})=>{a&&(document.getElementById("miniAiToggle").checked=a.enabled||!1,document.getElementById("miniApiKey").value=a.key||"")}),document.getElementById("miniSave").addEventListener("click",async()=>{const a={enabled:document.getElementById("miniAiToggle").checked,key:document.getElementById("miniApiKey").value.trim()};await chrome.storage.local.set({aiSettings:a}),r("Settings saved ‚úÖ"),setTimeout(()=>{t.remove(),e.style.display="block"},1500)}),document.getElementById("miniClearVault").addEventListener("click",async()=>{confirm("‚ö†Ô∏è Clear all vault entries? This cannot be undone!")&&(await chrome.storage.local.remove("vaultData"),r("Vault cleared üßπ"))}),document.getElementById("miniBack").addEventListener("click",()=>{t.remove(),e.style.display="block"})}const C=document.getElementById("backToMainBtn");C==null||C.addEventListener("click",()=>{const e=document.getElementById("vaultContainer"),t=document.getElementById("summaryBox");e.classList.add("hidden"),t.classList.remove("hidden"),r("Ready ‚úÖ")});function R(e,t="info"){const a=document.createElement("div");a.textContent=e,a.style.position="fixed",a.style.bottom="20px",a.style.left="50%",a.style.transform="translateX(-50%)",a.style.padding="10px 20px",a.style.borderRadius="8px",a.style.fontSize="0.9rem",a.style.zIndex="9999",a.style.boxShadow="0 4px 12px rgba(0, 0, 0, 0.3)",a.style.transition="all 0.3s ease",t==="success"?(a.style.background="rgba(34, 197, 94, 0.9)",a.style.color="white"):t==="error"?(a.style.background="rgba(239, 68, 68, 0.9)",a.style.color="white"):(a.style.background="rgba(59, 130, 246, 0.9)",a.style.color="white"),document.body.appendChild(a),setTimeout(()=>{a.style.opacity="1"},10),setTimeout(()=>{a.style.opacity="0",setTimeout(()=>a.remove(),300)},2500)}async function le(){try{let{userEmail:e}=await chrome.storage.local.get("userEmail");e||(e="publicuser@echomind.ai",console.log("No user email found, using public email for checkout"));const t=await fetch(`${ee}?email=${e}`,{method:"GET",headers:{"Content-Type":"application/json"}});if(!t.ok)throw new Error(`HTTP ${t.status}: ${t.statusText}`);const a=await t.json();if(a.status==="active"){console.log("‚úÖ EchoMind Pro verified active"),localStorage.setItem("isProActive","true"),localStorage.setItem("proActivatedAt",new Date().toISOString());const n=a.email||e;n&&n!=="publicuser@echomind.ai"&&(localStorage.setItem("echomind_pro_email",n),console.log("üíæ Saved user email for portal access:",n)),m==null||m.classList.remove("hidden"),y==null||y.classList.add("hidden"),r("‚ú® Pro Active","success");const o=localStorage.getItem("lastProToast"),i=Date.now();return(!o||i-parseInt(o)>36e5)&&(R("‚ú® EchoMind Pro activated ‚Äî welcome back!","success"),localStorage.setItem("lastProToast",i.toString())),localStorage.getItem("forgeWelcomeShown")||setTimeout(()=>{const s=document.getElementById("forge-welcome-popup");s&&(s.classList.remove("hidden"),s.style.opacity="1",s.style.transform="translateY(0)",s.style.animation="forgePulseText 4s ease-in-out 1",setTimeout(()=>{s.style.opacity="0",s.style.transform="translateY(10px)",localStorage.setItem("forgeWelcomeShown","true"),setTimeout(()=>{s.classList.add("hidden")},1e3)},5e3))},1500),!0}else return console.log("‚ö†Ô∏è EchoMind Pro inactive, showing upgrade box"),localStorage.setItem("isProActive","false"),m==null||m.classList.add("hidden"),y==null||y.classList.remove("hidden"),!1}catch(e){return console.error("Error checking subscription:",e),m==null||m.classList.add("hidden"),y==null||y.classList.remove("hidden"),R("‚ö†Ô∏è Could not verify Pro status. Try again later.","error"),!1}}async function Y(e){const t=e==="monthly"?T:S,a=t.innerHTML;try{t.innerHTML='<span style="font-size: 0.9rem;">‚è≥ Loading...</span>',t.disabled=!0,console.log(`Creating ${e} checkout session...`);const n=await fetch(`${Z}?plan=${e}`,{method:"POST",headers:{"Content-Type":"application/json"}});if(!n.ok)throw new Error(`HTTP ${n.status}: ${n.statusText}`);const o=await n.json();if(o.url)console.log("‚úÖ Checkout session created:",o.sessionId),chrome.tabs.create({url:o.url}),r(`Opening ${e} checkout...`,"success");else throw new Error("No checkout URL returned")}catch(n){console.error("‚ùå Error creating checkout session:",n),r("Checkout failed. Please try again.","error"),alert(`Failed to create checkout session: ${n.message}`),t.innerHTML=a,t.disabled=!1}}T==null||T.addEventListener("click",()=>Y("monthly"));S==null||S.addEventListener("click",()=>Y("annual"));function ie(){const e=m;!e||e.classList.contains("hidden")||(e.style.animation="forgePulse 2s ease-in-out 1",setTimeout(()=>{e.style.animation=""},2e3))}function ce(){const e=document.createElement("canvas");e.id="popup-confetti",e.style.position="fixed",e.style.top="0",e.style.left="0",e.style.width="100%",e.style.height="100%",e.style.pointerEvents="none",e.style.zIndex="9999",document.body.appendChild(e);const t=e.getContext("2d");e.width=window.innerWidth,e.height=window.innerHeight;const a=Array.from({length:80},()=>({x:Math.random()*e.width,y:Math.random()*e.height-e.height,size:Math.random()*4+2,color:`hsl(${Math.random()*360}, 100%, 60%)`,speed:Math.random()*3+1,angle:Math.random()*Math.PI*2}));function n(){t.clearRect(0,0,e.width,e.height),a.forEach(o=>{o.y+=o.speed,o.x+=Math.sin(o.angle)*.3,o.y>e.height&&(o.y=-10),t.fillStyle=o.color,t.fillRect(o.x,o.y,o.size,o.size)}),requestAnimationFrame(n)}n(),setTimeout(()=>{e.style.opacity="0",e.style.transition="opacity 1s ease",setTimeout(()=>e.remove(),1e3)},3e3)}function de(){const e=localStorage.getItem("isProActive")==="true",t=localStorage.getItem("lastProCelebration"),a=Date.now();e&&(!t||a-parseInt(t)>36e5)&&setTimeout(()=>{console.log("üéä Celebrating Pro activation!"),ie(),ce(),localStorage.setItem("lastProCelebration",a.toString())},800)}le().then(()=>{de()});W();function G(){console.log("üîÑ Resetting UI state..."),["settingsPanel","portalOverlay"].forEach(a=>{const n=document.getElementById(a);n&&(n.classList.add("hidden"),n.style.pointerEvents="none",n.style.opacity="0",n.style.display="none")});const t=document.getElementById("mainPanel");t&&(t.classList.remove("hidden"),t.style.display="block",t.style.pointerEvents="auto",t.style.opacity="1",t.classList.remove("translate-x-[-100%]","opacity-0"),t.classList.add("translate-x-0","opacity-100")),u&&(u.src="",u.classList.remove("loaded")),console.log("‚úÖ UI state reset complete")}document.addEventListener("keydown",e=>{e.key==="Escape"&&(k.classList.contains("hidden")?p.classList.contains("hidden")?G():q.click():J())});window.resetUIState=G;
