console.log("🧠 EchoMind background v0.3.3 loaded");if(typeof self<"u"){let m=function(){chrome.runtime.getPlatformInfo(()=>{})},c=function(){s||(s=setInterval(m,15e3),console.log("📚 Keep-alive heartbeat active"))},s=null;chrome.runtime.onStartup.addListener(c),c();async function h(){try{const e=await chrome.storage.local.get(["vaultData"]);return e.vaultData||(console.log("⚠️ No vault found — creating new one"),await chrome.storage.local.set({vaultData:{entries:[]}})),e.vaultData}catch(e){return console.error("❌ Vault load error, resetting:",e),await chrome.storage.local.clear(),await chrome.storage.local.set({vaultData:{entries:[]}}),{entries:[]}}}let o=null;async function d(e=""){if(o)try{await chrome.windows.update(o,{focused:!0}),console.log("🧶 Refocused EchoMind window");return}catch{o=null}const{lastSummaryLength:a}=await chrome.storage.local.get("lastSummaryLength"),t=600,n=560,l=a?Math.min(Math.ceil(a/400),4):0,i=n+l*150,u=t+Math.min(l*150,400);chrome.windows.create({url:chrome.runtime.getURL("popup.html")+e,type:"popup",width:u,height:i},r=>{r&&r.id&&(o=r.id,chrome.windows.update(r.id,{left:Math.round((r.left||0)+100),top:Math.round((r.top||0)+50),focused:!0}),console.log(`🧶 EchoMind window opened: ${u}×${i}`))})}chrome.windows.onRemoved.addListener(e=>{e===o&&(o=null,console.log("🧶 EchoMind window closed"))}),chrome.action.onClicked.addListener(()=>d("")),chrome.runtime.onInstalled.addListener(()=>{chrome.contextMenus.removeAll(()=>{chrome.contextMenus.create({id:"em_summarize",title:"🧠 EchoMind: Summarize",contexts:["selection"]}),chrome.contextMenus.create({id:"em_explain",title:"💡 EchoMind: Explain",contexts:["selection"]}),chrome.contextMenus.create({id:"em_proofread",title:"✏️ EchoMind: Proofread",contexts:["selection"]}),chrome.contextMenus.create({id:"em_translate_parent",title:"🌍 EchoMind: Translate →",contexts:["selection"]}),[{id:"em_translate_en",label:"English"},{id:"em_translate_es",label:"Spanish"},{id:"em_translate_fr",label:"French"},{id:"em_translate_ja",label:"Japanese"},{id:"em_translate_de",label:"German"},{id:"em_translate_it",label:"Italian"},{id:"em_translate_pt",label:"Portuguese"},{id:"em_translate_zh",label:"Chinese"},{id:"em_translate_ar",label:"Arabic"},{id:"em_translate_ru",label:"Russian"}].forEach(({id:a,label:t})=>{chrome.contextMenus.create({id:a,parentId:"em_translate_parent",title:`🌍 ${t}`,contexts:["selection"]})})})}),chrome.contextMenus.onClicked.addListener((e,a)=>{if(!e.selectionText)return;let t="summarize",n="English";if(e.menuItemId==="em_explain"&&(t="explain"),e.menuItemId==="em_proofread"&&(t="proofread"),e.menuItemId&&e.menuItemId.toString().startsWith("em_translate_")){t="translate";const l=e.menuItemId.toString().split("_")[2];n={en:"English",es:"Spanish",fr:"French",ja:"Japanese",de:"German",it:"Italian",pt:"Portuguese",zh:"Chinese",ar:"Arabic",ru:"Russian"}[l]||"English"}console.log(`📋 Context menu triggered: ${t}${t==="translate"?` → ${n}`:""}`),chrome.storage.local.set({pendingSummary:e.selectionText,pendingMode:t,targetLang:n,sourceTabId:(a==null?void 0:a.id)||null},()=>{setTimeout(()=>{d(`?mode=${t}`)},800)})}),chrome.runtime.onMessage.addListener((e,a,t)=>{if(e.type==="ping")return t({status:"ok",version:"0.3.3"}),!0;if(e.type==="getVault")return h().then(n=>t({data:n})),!0;if(e.type==="clearVault")return chrome.storage.local.clear(()=>{console.log("🧹 Vault cleared manually"),t({status:"cleared"})}),!0;if(e.type==="errorLog")return console.error("🧠 EchoMind error:",e.payload),t({status:"logged"}),!0}),chrome.runtime.onInstalled.addListener(()=>console.log("🌅 EchoMind installed")),console.log("✅ Background service ready")}
