function h(r){return r?r.startsWith("sk-or-")?"openrouter":r.startsWith("sk-ant-")?"anthropic":r.startsWith("AIza")?"gemini":r.startsWith("mistral-")||/^[A-Za-z0-9]{32,40}$/.test(r)?"mistral":r.startsWith("sk-")?"openai":"unknown":"unknown"}function f(r,a){var n,m,s,u,t,l,e,o,i,c,p,d,g;try{switch(r){case"openrouter":case"openai":case"mistral":return((u=(s=(m=(n=a.choices)==null?void 0:n[0])==null?void 0:m.message)==null?void 0:s.content)==null?void 0:u.trim())||"No summary available.";case"anthropic":return((e=(l=(t=a.content)==null?void 0:t[0])==null?void 0:l.text)==null?void 0:e.trim())||"No summary available.";case"gemini":return((g=(d=(p=(c=(i=(o=a.candidates)==null?void 0:o[0])==null?void 0:i.content)==null?void 0:c.parts)==null?void 0:p[0])==null?void 0:d.text)==null?void 0:g.trim())||"No summary available.";default:return"Unsupported provider response format."}}catch(x){return console.error("Error extracting summary:",x),"Error parsing AI response."}}function y(r){return r.length<=200?r:r.slice(0,200).trim()+"..."}async function $(r,a){if(!a.enableCloud||!a.apiKey)return y(r);const n=h(a.apiKey);if(n==="unknown")return"Invalid API key format. Please check your settings.";console.log(`ðŸ¤– Using ${n} for summarization`);let m,s,u;const l={openai:"gpt-4o-mini",openrouter:"openai/gpt-4o-mini",anthropic:"anthropic/claude-3.5-sonnet",mistral:"mistralai/mistral-medium",gemini:"google/gemini-pro"}[n]||"openai/gpt-4o-mini";n==="openai"?(m="https://api.openai.com/v1/chat/completions",s={Authorization:`Bearer ${a.apiKey}`,"Content-Type":"application/json"},u={model:"gpt-4o-mini",messages:[{role:"system",content:"You are a helpful assistant that creates concise summaries."},{role:"user",content:`Summarize this text concisely:

${r}`}],max_tokens:500}):(m="https://openrouter.ai/api/v1/chat/completions",s={Authorization:`Bearer ${a.apiKey}`,"HTTP-Referer":"https://echomind-pro-launch.vercel.app","X-Title":"EchoMind Pro","Content-Type":"application/json"},u={model:l,messages:[{role:"system",content:"You are a helpful assistant that creates concise summaries."},{role:"user",content:`Summarize this text concisely:

${r}`}],max_tokens:500});try{console.log(`ðŸ“¡ Endpoint: ${m}`),console.log("ðŸ“‹ Headers:",s),console.log("ðŸ“¦ Body:",u);const e=await fetch(m,{method:"POST",headers:s,body:JSON.stringify(u)});if(console.log(`ðŸ“Š Response status: ${e.status} ${e.statusText}`),!e.ok){const c=await e.text();return console.error(`âŒ API Error (${e.status}):`,c),`âŒ ${n} Error: ${e.status} - ${e.statusText}`}const o=await e.json();console.log("ðŸ“¥ Response data:",o);const i=f(n,o);return console.log(`âœ… Extracted summary (${i.length} chars):`,i.substring(0,100)+"..."),i}catch(e){return console.error(`âŒ Error calling ${n} API:`,e),`âŒ ${n} Error: ${e instanceof Error?e.message:"Unknown error"}`}}async function E(r,a){if(!a.enableCloud||!a.apiKey)return`This text is about: ${y(r)}`;const n=h(a.apiKey);if(n==="unknown")return"Invalid API key format. Please check your settings.";let m,s,u;const l={openai:"gpt-4o-mini",openrouter:"openai/gpt-4o-mini",anthropic:"anthropic/claude-3.5-sonnet",mistral:"mistralai/mistral-medium",gemini:"google/gemini-pro"}[n]||"openai/gpt-4o-mini";n==="openai"?(m="https://api.openai.com/v1/chat/completions",s={Authorization:`Bearer ${a.apiKey}`,"Content-Type":"application/json"},u={model:"gpt-4o-mini",messages:[{role:"system",content:"You are a helpful assistant that explains complex topics in simple terms."},{role:"user",content:`Explain this text in simple terms:

${r}`}],max_tokens:500}):(m="https://openrouter.ai/api/v1/chat/completions",s={Authorization:`Bearer ${a.apiKey}`,"HTTP-Referer":"https://echomind-pro-launch.vercel.app","X-Title":"EchoMind Pro","Content-Type":"application/json"},u={model:l,messages:[{role:"system",content:"You are a helpful assistant that explains complex topics in simple terms."},{role:"user",content:`Explain this text in simple terms:

${r}`}],max_tokens:500});try{console.log(`ðŸ¤– Using ${n} for explanation`),console.log(`ðŸ“¡ Endpoint: ${m}`),console.log("ðŸ“‹ Headers:",s),console.log("ðŸ“¦ Body:",u);const e=await fetch(m,{method:"POST",headers:s,body:JSON.stringify(u)});if(console.log(`ðŸ“Š Response status: ${e.status} ${e.statusText}`),!e.ok){const c=await e.text();return console.error(`âŒ API Error (${e.status}):`,c),`âŒ ${n} Error: ${e.status} - ${e.statusText}`}const o=await e.json();console.log("ðŸ“¥ Response data:",o);const i=f(n,o);return console.log(`âœ… Extracted explanation (${i.length} chars):`,i.substring(0,100)+"..."),i}catch(e){return console.error(`âŒ Error calling ${n} API:`,e),`âŒ ${n} Error: ${e instanceof Error?e.message:"Unknown error"}`}}console.log("ðŸ§  EchoMind background v2.0.0 loaded");if(typeof self<"u"){let r=function(){chrome.runtime.getPlatformInfo(()=>{})},a=function(){n||(n=setInterval(r,15e3),console.log("ðŸ“š Keep-alive heartbeat active"))},n=null;chrome.runtime.onStartup.addListener(a),a();async function m(){try{const t=await chrome.storage.local.get(["vaultData"]);return t.vaultData||(console.log("âš ï¸ No vault found â€” creating new one"),await chrome.storage.local.set({vaultData:{entries:[]}})),t.vaultData}catch(t){return console.error("âŒ Vault load error, resetting:",t),await chrome.storage.local.clear(),await chrome.storage.local.set({vaultData:{entries:[]}}),{entries:[]}}}let s=null;async function u(t=""){if(s)try{await chrome.windows.update(s,{focused:!0}),console.log("ðŸ§¶ Refocused EchoMind window");return}catch{s=null}const{lastSummaryLength:l}=await chrome.storage.local.get("lastSummaryLength"),e=600,o=560,i=l?Math.min(Math.ceil(l/400),4):0,c=o+i*150,p=e+Math.min(i*150,400);chrome.windows.create({url:chrome.runtime.getURL("popup.html")+t,type:"popup",width:p,height:c},d=>{d&&d.id&&(s=d.id,chrome.windows.update(d.id,{left:Math.round((d.left||0)+100),top:Math.round((d.top||0)+50),focused:!0}),console.log(`ðŸ§¶ EchoMind window opened: ${p}Ã—${c}`))})}chrome.windows.onRemoved.addListener(t=>{t===s&&(s=null,console.log("ðŸ§¶ EchoMind window closed"))}),chrome.action.onClicked.addListener(()=>u("")),chrome.runtime.onInstalled.addListener(()=>{chrome.contextMenus.removeAll(()=>{chrome.contextMenus.create({id:"em_summarize",title:"ðŸ§  EchoMind: Summarize",contexts:["selection"]}),chrome.contextMenus.create({id:"em_explain",title:"ðŸ’¡ EchoMind: Explain",contexts:["selection"]}),chrome.contextMenus.create({id:"em_proofread",title:"âœï¸ EchoMind: Proofread",contexts:["selection"]}),chrome.contextMenus.create({id:"em_translate_parent",title:"ðŸŒ EchoMind: Translate â†’",contexts:["selection"]}),[{id:"em_translate_en",label:"English"},{id:"em_translate_es",label:"Spanish"},{id:"em_translate_fr",label:"French"},{id:"em_translate_ja",label:"Japanese"},{id:"em_translate_de",label:"German"},{id:"em_translate_it",label:"Italian"},{id:"em_translate_pt",label:"Portuguese"},{id:"em_translate_zh",label:"Chinese"},{id:"em_translate_ar",label:"Arabic"},{id:"em_translate_ru",label:"Russian"}].forEach(({id:l,label:e})=>{chrome.contextMenus.create({id:l,parentId:"em_translate_parent",title:`ðŸŒ ${e}`,contexts:["selection"]})})})}),chrome.contextMenus.onClicked.addListener((t,l)=>{if(!t.selectionText)return;let e="summarize",o="English";if(t.menuItemId==="em_explain"&&(e="explain"),t.menuItemId==="em_proofread"&&(e="proofread"),t.menuItemId&&t.menuItemId.toString().startsWith("em_translate_")){e="translate";const i=t.menuItemId.toString().split("_")[2];o={en:"English",es:"Spanish",fr:"French",ja:"Japanese",de:"German",it:"Italian",pt:"Portuguese",zh:"Chinese",ar:"Arabic",ru:"Russian"}[i]||"English"}console.log(`ðŸ“‹ Context menu triggered: ${e}${e==="translate"?` â†’ ${o}`:""}`),chrome.storage.local.set({pendingSummary:t.selectionText,pendingMode:e,targetLang:o,sourceTabId:(l==null?void 0:l.id)||null},()=>{setTimeout(()=>{u(`?mode=${e}`)},800)})}),chrome.runtime.onMessage.addListener((t,l,e)=>{if(t.type==="ping")return e({status:"ok",version:"2.0.0"}),!0;if(t.type==="getVault")return m().then(o=>e({data:o})),!0;if(t.type==="clearVault")return chrome.storage.local.clear(()=>{console.log("ðŸ§¹ Vault cleared manually"),e({status:"cleared"})}),!0;if(t.type==="errorLog")return console.error("ðŸ§  EchoMind error:",t.payload),e({status:"logged"}),!0;if(t.type==="summarize")return(async()=>{try{const{openaiKey:o,enableCloud:i}=await chrome.storage.local.get(["openaiKey","enableCloud"]),c=h(o||"");console.log(`ðŸ¤– Summarizing with ${c||"local fallback"}`);const p=await $(t.text,{apiKey:o||"",enableCloud:i||!1});e({success:!0,result:p,provider:c})}catch(o){console.error("Summarize error:",o),e({success:!1,error:o instanceof Error?o.message:"Unknown error"})}})(),!0;if(t.type==="explain")return(async()=>{try{const{openaiKey:o,enableCloud:i}=await chrome.storage.local.get(["openaiKey","enableCloud"]),c=h(o||"");console.log(`ðŸ¤– Explaining with ${c||"local fallback"}`);const p=await E(t.text,{apiKey:o||"",enableCloud:i||!1});e({success:!0,result:p,provider:c})}catch(o){console.error("Explain error:",o),e({success:!1,error:o instanceof Error?o.message:"Unknown error"})}})(),!0}),chrome.runtime.onInstalled.addListener(()=>console.log("ðŸŒ… EchoMind installed")),console.log("âœ… Background service ready")}
